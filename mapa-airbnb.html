<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mapa – Imóveis & Terrenos (Airbnb style)</title>

  <!-- Mapbox GL -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>

  <style>
    :root { --bg:#ffffff; --fg:#111; --muted:#666; --border:#e7e7e7; }
    * { box-sizing: border-box; }
    html,body { height:100%; margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; color:var(--fg); }
    .app { display:grid; grid-template-columns: 420px 1fr; height:100%; }
    #sidebar { border-right:1px solid var(--border); overflow:auto; padding:10px; }
    #map { width:100%; height:100%; }

    .filters { position:sticky; top:0; background:#fff; z-index:10; padding:10px; border-bottom:1px solid var(--border); }
    .filters label { font-size:12px; color:var(--muted); margin-right:8px; }
    .filters select, .filters input { padding:6px 8px; border:1px solid var(--border); border-radius:8px; font-size:13px; }

    .list { display:grid; gap:10px; padding:10px 0; }
    .card { display:grid; grid-template-columns: 120px 1fr; gap:10px; border:1px solid var(--border); border-radius:12px; overflow:hidden; cursor:pointer; background:#fff; }
    .card img { width:120px; height:100%; object-fit:cover; }
    .info { padding:8px; }
    .info h4 { margin:0 0 6px; font-size:15px; line-height:1.2 }
    .price { font-weight:700; margin-bottom:4px; }
    .meta { font-size:12px; color:var(--muted); }

    /* Pílula de preço (marker HTML) */
    .price-pill {
      padding:6px 10px; border-radius:18px; background:#fff; box-shadow:0 2px 10px rgba(0,0,0,.18);
      font-weight:700; font-size:12px; display:inline-flex; gap:6px; align-items:center; white-space:nowrap;
      border:1px solid rgba(0,0,0,.06);
    }
    .price-pill .badge { font:700 10px/1 system-ui; padding:2px 6px; border-radius:10px; background:#111; color:#fff; }
    .price-pill.vendido { opacity:.55; filter:grayscale(.4); }
    .price-pill:hover { transform: scale(1.06); }

    /* Popup conteúdo */
    .popup-card { width:240px; }
    .popup-card img { width:100%; height:120px; object-fit:cover; border-radius:8px; }
    .popup-card h3 { margin:8px 0 4px; font-size:14px; }
    .popup-actions { display:flex; gap:8px; margin-top:8px; }
    .btn { flex:1; text-align:center; padding:8px; border-radius:8px; text-decoration:none; font-weight:600; font-size:13px; }
    .btn-primary { background:#111; color:#fff; }
    .btn-outline { border:1px solid #111; color:#111; }
  </style>
</head>
<body>

<div class="app">
  <aside id="sidebar">
    <div class="filters">
      <label>Tipo:
        <select id="f-tipo">
          <option value="">Todos</option>
          <option value="terreno">Terreno</option>
          <option value="casa">Casa</option>
          <option value="loteamento">Loteamento</option>
          <option value="comercial">Comercial</option>
          <option value="pousada">Pousada</option>
        </select>
      </label>
      <label>Status:
        <select id="f-status">
          <option value="disponivel">Disponível</option>
          <option value="">Todos</option>
          <option value="reservado">Reservado</option>
          <option value="vendido">Vendido</option>
        </select>
      </label>
      <label>Preço máx. (R$):
        <input id="f-max" type="number" placeholder="Sem limite" min="0" style="width:120px" />
      </label>
    </div>
    <div class="list" id="list"></div>
  </aside>

  <div id="map"></div>
</div>

<script>
  // 1) CONFIG
  mapboxgl.accessToken = 'COLOQUE_SEU_MAPBOX_TOKEN_AQUI';

  const START = { center: [-40.512, -2.796], zoom: 12 }; // Jeri

  // 2) MAPA
  const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/streets-v12',
    center: START.center,
    zoom: START.zoom
  });

  // 3) CARREGAR DADOS
  let ALL = [];         // GeoJSON Features
  let MARKERS = [];     // HTML markers atuais (aparecem no zoom >= 13)
  function formatBRL(n){ return Number(n).toLocaleString('pt-BR'); }

  // Constrói Feature a partir do seu JSON atual
  function toFeature(item, idx) {
    const lat = Number(item.latitude ?? item.lat);
    const lng = Number(item.longitude ?? item.lng);
    if (Number.isNaN(lat) || Number.isNaN(lng)) return null;
    const id = item.id || item.codigo || `imv_${idx}`;
    return {
      type: 'Feature',
      properties: {
        id,
        titulo: item.nome || item.titulo || 'Imóvel',
        descricao: item.descricao || '',
        preco: Number(item.preco) || 0,
        tipo: (item.tipo || '').toLowerCase(),
        status: (item.status || 'disponivel').toLowerCase(),
        capa: item.imagem_capa || item.capa || (item.imagem || ''),
        galeria: item.galeria || [],
        url: item.url || '',
        whatsapp: (item.whatsapp || '').replace(/\D/g,''),
        quartos: Number(item.quartos || 0),
        area_m2: Number(item.area_m2 || 0),
        financia: Boolean(item.financia)
      },
      geometry: { type:'Point', coordinates:[lng, lat] }
    };
  }

  async function loadData() {
    // seu repo publica em /pontos.json; adiciono cache-buster
    const res = await fetch('./pontos.json?ts=' + Date.now());
    const raw = await res.json();
    // raw pode ser {pontos:[...]} ou um array direto; trato os dois
    const arr = Array.isArray(raw) ? raw : (raw.pontos || raw.items || []);
    ALL = arr.map(toFeature).filter(Boolean);
  }

  // 4) MARKERS (pílula) + POPUP
  function makeMarker(feature){
    const el = document.createElement('div');
    el.className = 'price-pill' + (feature.properties.status === 'vendido' ? ' vendido' : '');
    el.textContent = `R$ ${formatBRL(feature.properties.preco)}`;
    if (feature.properties.status !== 'disponivel') {
      const b = document.createElement('span'); b.className='badge';
      b.textContent = feature.properties.status.toUpperCase();
      el.appendChild(b);
    }
    const marker = new mapboxgl.Marker({ element: el, anchor:'bottom' })
      .setLngLat(feature.geometry.coordinates)
      .addTo(map);

    el.addEventListener('click', () => {
      const p = feature.properties;
      const msg = encodeURIComponent(`Olá! Tenho interesse no imóvel ${p.id} – ${p.titulo} (R$ ${formatBRL(p.preco)}).`);
      const wa = p.whatsapp ? `https://wa.me/${p.whatsapp}?text=${msg}` : '#';
      const html = `
        <article class="popup-card">
          ${p.capa ? `<img src="${p.capa}" alt=""/>` : ''}
          <h3>${p.titulo}</h3>
          <div style="font-weight:700">R$ ${formatBRL(p.preco)}</div>
          <div style="font-size:12px;color:#666">${p.tipo || ''} • ${p.quartos||0} qts • ${p.area_m2||0} m²</div>
          <div class="popup-actions">
            ${p.url ? `<a class="btn btn-primary" target="_blank" href="${p.url}">Ver detalhes</a>` : ''}
            ${p.whatsapp ? `<a class="btn btn-outline" target="_blank" href="${wa}">WhatsApp</a>` : ''}
          </div>
        </article>`;
      new mapboxgl.Popup({ offset: 12 }).setLngLat(feature.geometry.coordinates).setHTML(html).addTo(map);
    });

    return marker;
  }

  function clearMarkers(){
    for (const m of MARKERS) m.remove();
    MARKERS = [];
  }

  function paintMarkers(features){
    clearMarkers();
    // Só mostrar pílulas no zoom mais próximo (efeito Airbnb)
    if (map.getZoom() < 13) return;
    MARKERS = features.map(makeMarker);
  }

  // 5) LISTA (sidebar) sincronizada ao viewport
  function inViewport(f){
    const b = map.getBounds();
    const [lng,lat] = f.geometry.coordinates;
    return lng>=b.getWest() && lng<=b.getEast() && lat>=b.getSouth() && lat<=b.getNorth();
  }
  function applyFilters(features){
    const tipo = document.getElementById('f-tipo').value;
    const status = document.getElementById('f-status').value;
    const max = Number(document.getElementById('f-max').value || Infinity);
    return features.filter(f=>{
      const p = f.properties;
      return (tipo ? p.tipo===tipo : true)
          && (status ? p.status===status : true)
          && (p.preco <= max);
    });
  }
  function renderList(features){
    const list = document.getElementById('list');
    list.innerHTML = features.map(f=>{
      const p = f.properties;
      return `
      <article class="card" data-id="${p.id}">
        ${p.capa ? `<img src="${p.capa}" alt="">` : `<img src="https://via.placeholder.com/240x160?text=Sem+foto" alt="">`}
        <div class="info">
          <h4>${p.titulo}</h4>
          <div class="price">R$ ${formatBRL(p.preco)}</div>
          <div class="meta">${p.tipo||''} • ${p.quartos||0} qts • ${p.area_m2||0} m² ${p.status!=='disponivel' ? ' • '+p.status.toUpperCase() : ''}</div>
        </div>
      </article>`;
    }).join('');

    // clique na card → voar para o ponto + abrir popup
    list.querySelectorAll('.card').forEach(card=>{
      card.addEventListener('click', ()=>{
        const f = features.find(x=>x.properties.id === card.dataset.id);
        map.flyTo({ center: f.geometry.coordinates, zoom: 15 });
        // dispara o clique do marker (se existir). Se não existir (zoom), mostra popup direto:
        const p = f.properties;
        const msg = encodeURIComponent(`Olá! Tenho interesse no imóvel ${p.id} – ${p.titulo} (R$ ${formatBRL(p.preco)}).`);
        const wa = p.whatsapp ? `https://wa.me/${p.whatsapp}?text=${msg}` : '#';
        const html = `
          <article class="popup-card">
            ${p.capa ? `<img src="${p.capa}" alt=""/>` : ''}
            <h3>${p.titulo}</h3>
            <div style="font-weight:700">R$ ${formatBRL(p.preco)}</div>
            <div style="font-size:12px;color:#666">${p.tipo || ''} • ${p.quartos||0} qts • ${p.area_m2||0} m²</div>
            <div class="popup-actions">
              ${p.url ? `<a class="btn btn-primary" target="_blank" href="${p.url}">Ver detalhes</a>` : ''}
              ${p.whatsapp ? `<a class="btn btn-outline" target="_blank" href="${wa}">WhatsApp</a>` : ''}
            </div>
          </article>`;
        new mapboxgl.Popup({ offset: 12 }).setLngLat(f.geometry.coordinates).setHTML(html).addTo(map);
      });
    });
  }

  function syncUI(){
    const filtered = applyFilters(ALL);
    const vis = filtered.filter(inViewport);
    renderList(vis);
    paintMarkers(vis);
  }

  // 6) INICIALIZAÇÃO
  (async function init(){
    await loadData();

    // fonte para clusters (opcional: você pode remover se for usar só HTML markers)
    map.on('load', () => {
      map.addSource('imoveis', { type:'geojson', data: { type:'FeatureCollection', features: ALL }, cluster:true, clusterRadius:50 });

      map.addLayer({
        id:'clusters', type:'circle', source:'imoveis', filter:['has','point_count'],
        paint:{ 'circle-radius':['step',['get','point_count'],16,50,22,100,28], 'circle-color':'#a0c4ff' }
      });
      map.addLayer({
        id:'cluster-count', type:'symbol', source:'imoveis', filter:['has','point_count'],
        layout:{ 'text-field':['get','point_count_abbreviated'], 'text-size':12 }
      });

      // quando o zoom for alto, esconda clusters e mostre markers HTML
      function toggleLayers(){
        const z = map.getZoom();
        map.setLayoutProperty('clusters', 'visibility', z < 13 ? 'visible' : 'none');
        map.setLayoutProperty('cluster-count', 'visibility', z < 13 ? 'visible' : 'none');
        syncUI();
      }

      map.on('moveend', syncUI);
      map.on('zoomend', toggleLayers);

      // filtros
      ['f-tipo','f-status','f-max'].forEach(id => {
        document.getElementById(id).addEventListener('change', syncUI);
        document.getElementById(id).addEventListener('input', syncUI);
      });

      toggleLayers(); // primeira pintura
    });
  })();
</script>
</body>
</html>
